<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Hashmancer Portal</title>
<link href="https://fonts.googleapis.com/css2?family=UnifrakturCook&display=swap" rel="stylesheet">
<style>
body { font-family: Arial, sans-serif; margin:10px; background:#000; color:#0f0; }
h1 { color:#0f0; text-align:center; font-family:'UnifrakturCook', cursive; }
section { margin-bottom:1.2em; }
table { width:100%; border-collapse:collapse; margin-top:0.5em; }
th,td { border:1px solid #0f0; padding:4px; text-align:center; }
input, textarea, select { background:#111; color:#0f0; border:1px solid #0f0; }
button { margin-top:4px; }
pre { background:#111; color:#0f0; padding:5px; overflow:auto; max-height:200px; }
#logo { border:none; background:none; margin:0; font-family:monospace; white-space:pre; text-align:center; }
#login-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.9);
  color: #0f0;
  display: none;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  text-align: center;
}
#login-overlay input { background:#111; color:#0f0; border:1px solid #0f0; margin-top:4px; }

@keyframes runes {
  from { transform: translate(-10%, -10%) rotate(0deg); }
  to   { transform: translate(10%, 10%) rotate(360deg); }
}
body::before {
  content: "ᚠᚢᚦᚩᚱᚴ";
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  font-family: 'UnifrakturCook', cursive;
  font-size: 8rem;
  color: #0f0;
  opacity: 0.03;
  pointer-events: none;
  animation: runes 40s linear infinite;
}
</style>
</head>
<body>
<h1>Hashmancer Portal</h1>
<button onclick="location.href='/glyph'">Open Glyph</button>
<button onclick="logout()">Logout</button>
<div id="login-overlay">
  <h2>Portal Login</h2>
  <input type="password" id="passkey" placeholder="passkey">
  <button onclick="submitPasskey()">Login</button>
  <div id="login-error" style="color:red; margin-top:4px;"></div>
</div>
<pre id="logo">██╗  ██╗ █████╗ ███████╗██╗  ██╗███╗   ███╗ █████╗ ███╗   ██╗ ██████╗███████╗███
███╗
██║  ██║██╔══██╗██╔════╝██║  ██║████╗ ████║██╔══██╗████╗  ██║██╔════╝██╔════╝██╔
══██╗
███████║███████║███████╗███████║██╔████╔██║███████║██╔██╗ ██║██║     █████╗  ███
███╔╝
██╔══██║██╔══██║╚════██║██╔══██║██║╚██╔╝██║██╔══██║██║╚██╗██║██║     ██╔══╝  ██╔
══██╗
██║  ██║██║  ██║███████║██║  ██║██║ ╚═╝ ██║██║  ██║██║ ╚████║╚██████╗███████╗██║
  ██║
╚═╝  ╚═╝╚═╝  ╚═╝╚══════╝╚═╝  ╚═╝╚═╝     ╚═╝╚═╝  ╚═╝╚═╝  ╚═══╝ ╚═════╝╚══════╝╚═╝
  ╚═╝</pre>

<section id="metrics">
<div>Workers: <span id="workers">0</span></div>
<div>Queue Length: <span id="queue">0</span></div>
<div>Found Results: <span id="results">0</span></div>
<div>GPU Temps: <span id="gpu">N/A</span></div>
<div id="updated">Updated: never</div>
</section>

<section id="founds">
<h2>Found Hashes</h2>
<pre id="found-output"></pre>
</section>

<section id="all-founds">
<h2>All Found Results</h2>
<button onclick="loadAllFounds()">Refresh</button>
<pre id="all-found-output"></pre>
</section>

<section id="restores">
<h2>Restore Files</h2>
<ul id="restore-list"></ul>
<input type="file" id="restore-upload">
<button onclick="uploadRestore()">Upload</button>
</section>

<section id="dicts">
<h2>Dictionaries</h2>
<ul id="dict-list"></ul>
<input type="file" id="dict-upload">
<button onclick="uploadDict()">Upload</button>
</section>

<section id="import-hashes">
<h2>Import Hashes</h2>
<input type="file" id="hash-file">
<input type="number" id="hash-mode">
<button onclick="uploadHashes()">Upload</button>
</section>

<section id="masks">
<h2>Masks</h2>
<ul id="mask-list"></ul>
<input type="text" id="mask-name" placeholder="mask name">
<textarea id="mask-content" rows="2" placeholder="mask content"></textarea>
<button onclick="createMask()">Create</button>
</section>

<section id="workers">
<h2>Workers</h2>
<table><thead><tr><th>Worker</th><th>Status</th><th>Change</th></tr></thead>
<tbody id="worker-body"></tbody></table>
</section>

<section id="logs">
<h2>Logs</h2>
<select id="log-worker" onchange="loadLogs()"></select>
<pre id="log-output"></pre>
</section>

<section id="jobs">
<h2>Jobs</h2>
<table><thead><tr><th>ID</th><th>Status</th><th>Attack</th></tr></thead>
<tbody id="job-body"></tbody></table>
</section>

<section id="hashes-settings">
<h2>Hashes.com Settings</h2>
<div>API Key: <input type="password" id="hashes-key"><button onclick="saveHashesKey()">Save</button></div>
<div>Algorithms: <input type="text" id="hashes-algos"><button onclick="saveHashesAlgos()">Save</button></div>
<div>Poll Interval: <input type="number" id="hashes-poll" value="0"><button onclick="saveHashesPoll()">Save</button></div>
<div>Masks: <input type="text" id="predef-masks"><button onclick="savePredefMasks()">Save</button></div>
</section>

<section id="hashes-jobs">
<h2>Hashes.com Jobs</h2>
<button onclick="loadHashesJobs()">Refresh</button>
<table><thead><tr><th>ID</th><th>Algorithm</th><th>Priority</th><th>Save</th></tr></thead>
<tbody id="hashes-job-body"></tbody></table>
</section>

<section id="algo-params">
<h2>Algorithm Parameters</h2>
<div>
  <input type="text" id="algo-name" placeholder="algorithm">
  <input type="number" id="algo-masklen" placeholder="mask length">
  <input type="text" id="algo-rule" placeholder="rule file">
  <button onclick="saveAlgoParams()">Save</button>
</div>
<pre id="algo-params-output"></pre>
</section>

<section id="markov">
<h2>Markov Training</h2>
<div>
  <select id="markov-language">
    <option value="english">english</option>
    <option value="german">german</option>
    <option value="french">french</option>
    <option value="spanish">spanish</option>
  </select>
  <button onclick="trainMarkov()">Train Markov</button>
  <button onclick="changeMarkovLang()">Set Active</button>
</div>
<div>
  <label><input type="checkbox" id="prob-order" onchange="updateProbOrder()"> Probabilistic Ordering</label>
</div>
<div>
  <label><input type="checkbox" id="inverse-order" onchange="updateInverseOrder()"> Inverse Order</label>
</div>
<div>Current Language: <span id="current-markov-lang"></span></div>
  <div>Probabilistic Order: <span id="current-prob-order"></span></div>
  <div>Inverse Order: <span id="current-inverse-order"></span></div>
</section>

<section id="llm-training">
<h2>LLM Training</h2>
<div>
  <input type="text" id="llm-dataset" placeholder="dataset path">
  <input type="text" id="llm-base-model" placeholder="base model path">
  <input type="number" id="llm-epochs" placeholder="epochs" value="1">
  <input type="number" step="0.0001" id="llm-lr" placeholder="learning rate" value="0.0001">
  <input type="text" id="llm-output" placeholder="output directory">
  <button onclick="trainLLM()">Train LLM</button>
</div>
</section>

<script>
function applyMetrics(data){
  document.getElementById('workers').textContent = data.worker_count;
  document.getElementById('queue').textContent = data.queue_length;
  document.getElementById('results').textContent = data.found_results;
  document.getElementById('gpu').textContent = (data.gpu_temps || []).join(',');
  document.getElementById('updated').textContent = 'Updated: ' + new Date().toLocaleTimeString();
  document.getElementById('current-prob-order').textContent = data.probabilistic_order ? 'on' : 'off';
  document.getElementById('current-inverse-order').textContent = data.inverse_prob_order ? 'on' : 'off';
  document.getElementById('current-markov-lang').textContent = data.markov_lang || '';
  document.getElementById('prob-order').checked = !!data.probabilistic_order;
  document.getElementById('inverse-order').checked = !!data.inverse_prob_order;
  document.getElementById('markov-language').value = data.markov_lang || 'english';
  if(data.llm_train_epochs!==undefined){
    document.getElementById('llm-epochs').value = data.llm_train_epochs;
  }
  if(data.llm_train_learning_rate!==undefined){
    document.getElementById('llm-lr').value = data.llm_train_learning_rate;
  }
}
async function updateMetrics(){
  const res = await fetch('/server_status');
  const data = await res.json();
  applyMetrics(data);
}

async function loadDicts(){
  const res = await fetch('/wordlists');
  const data = await res.json();
  const list = document.getElementById('dict-list');
  list.innerHTML='';
  for(const name of data){
    const li=document.createElement('li');
    const btn=document.createElement('button');
    btn.textContent='Delete';
    btn.onclick=async()=>{ await fetch(`/wordlist/${encodeURIComponent(name)}`,{method:'DELETE'}); loadDicts(); };
    li.textContent=name+' ';
    li.appendChild(btn);
    list.appendChild(li);
  }
}

async function uploadDict(){
  const file=document.getElementById('dict-upload').files[0];
  if(!file) return;
  const fd=new FormData();
  fd.append('file',file);
  await fetch('/upload_wordlist',{method:'POST',body:fd});
  document.getElementById('dict-upload').value='';
  loadDicts();
}

async function loadRestores(){
  const res=await fetch('/restores');
  const data=await res.json();
  const list=document.getElementById('restore-list');
  list.innerHTML='';
  for(const name of data){
    const li=document.createElement('li');
    const del=document.createElement('button');
    del.textContent='Delete';
    del.onclick=async()=>{ await fetch(`/restore/${encodeURIComponent(name)}`,{method:'DELETE'}); loadRestores(); };
    const dl=document.createElement('a');
    dl.textContent='Download';
    dl.href=`/download_restore/${encodeURIComponent(name)}`;
    dl.style.color='#0f0';
    li.textContent=name+' ';
    li.appendChild(del);
    li.appendChild(document.createTextNode(' '));
    li.appendChild(dl);
    list.appendChild(li);
  }
}

async function uploadRestore(){
  const file=document.getElementById('restore-upload').files[0];
  if(!file) return;
  const fd=new FormData();
  fd.append('file',file);
  await fetch('/upload_restore',{method:'POST',body:fd});
  document.getElementById('restore-upload').value='';
  loadRestores();
}

async function uploadHashes(){
  const file=document.getElementById('hash-file').files[0];
  if(!file) return;
  const mode=document.getElementById('hash-mode').value.trim();
  const fd=new FormData();
  fd.append('file',file);
  if(mode) fd.append('hash_mode',mode);
  await fetch('/import_hashes',{method:'POST',body:fd});
  document.getElementById('hash-file').value='';
  document.getElementById('hash-mode').value='';
  updateMetrics();
  loadJobs();
}

async function loadAllFounds(){
  const res=await fetch('/found_results?limit=1000');
  const data=await res.json();
  document.getElementById('all-found-output').textContent=data.join('\n');
}

async function loadMasks(){
  const res=await fetch('/masks');
  const data=await res.json();
  const list=document.getElementById('mask-list');
  list.innerHTML='';
  for(const name of data){
    const li=document.createElement('li');
    const btn=document.createElement('button');
    btn.textContent='Delete';
    btn.onclick=async()=>{ await fetch(`/mask/${encodeURIComponent(name)}`,{method:'DELETE'}); loadMasks(); };
    li.textContent=name+' ';
    li.appendChild(btn);
    list.appendChild(li);
  }
}

async function createMask(){
  const name=document.getElementById('mask-name').value.trim();
  const content=document.getElementById('mask-content').value;
  if(!name) return;
  await fetch('/create_mask',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,content})});
  document.getElementById('mask-name').value='';
  document.getElementById('mask-content').value='';
  loadMasks();
}

async function loadWorkers(){
  const res=await fetch('/workers');
  const workers=await res.json();
  const tbody=document.getElementById('worker-body');
  const sel=document.getElementById('log-worker');
  tbody.innerHTML=''; sel.innerHTML='<option value="">All</option>';
  for(const w of workers){
    const tr=document.createElement('tr');
    const nameTd=document.createElement('td');
    nameTd.textContent=w.name;
    const statusTd=document.createElement('td');
    statusTd.textContent=w.status;
    const actionTd=document.createElement('td');
    const select=document.createElement('select');
    for(const opt of ['idle','maintenance','offline']){
      const o=document.createElement('option');
      o.value=opt; o.textContent=opt;
      if(opt===w.status) o.selected=true;
      select.appendChild(o);
    }
    select.onchange=async()=>{
      await fetch('/worker_status',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:w.name,status:select.value})});
      statusTd.textContent=select.value;
    };
    actionTd.appendChild(select);
    tr.appendChild(nameTd); tr.appendChild(statusTd); tr.appendChild(actionTd);
    tbody.appendChild(tr);

    const option=document.createElement('option');
    option.value=w.name; option.textContent=w.name;
    sel.appendChild(option);
  }
}

async function loadLogs(){
  const worker=document.getElementById('log-worker').value;
  const url=worker?`/logs?worker=${encodeURIComponent(worker)}`:'/logs';
  const res=await fetch(url);
  const data=await res.json();
  const pre=document.getElementById('log-output');
  pre.textContent=data.map(e=>`${e.datetime} [${e.worker_id}] ${e.message}`).join('\n');
}

async function loadJobs(){
  const res=await fetch('/jobs');
  const jobs=await res.json();
  const tbody=document.getElementById('job-body');
  tbody.innerHTML='';
  for(const j of jobs){
    const tr=document.createElement('tr');
    const idTd=document.createElement('td');
    idTd.textContent=j.job_id;
    const statusTd=document.createElement('td');
    statusTd.textContent=j.status;
    const modeTd=document.createElement('td');
    modeTd.textContent=j.attack_mode||'';
    tr.appendChild(idTd); tr.appendChild(statusTd); tr.appendChild(modeTd);
    tbody.appendChild(tr);
  }
}

async function saveHashesKey(){
  const key=document.getElementById('hashes-key').value.trim();
  await fetch('/hashes_api_key',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({api_key:key})});
}

async function saveHashesAlgos(){
  const txt=document.getElementById('hashes-algos').value.trim();
  const algos=txt?txt.split(',').map(a=>a.trim()):[];
  await fetch('/hashes_algorithms',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({algorithms:algos})});
}

async function saveHashesPoll(){
  const interval=parseInt(document.getElementById('hashes-poll').value,10)||0;
  await fetch('/hashes_settings',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({hashes_poll_interval:interval})});
}

async function savePredefMasks(){
  const txt=document.getElementById('predef-masks').value.trim();
  const masks=txt?txt.split(',').map(m=>m.trim()).filter(m=>m):[];
  await fetch('/predefined_masks',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({masks})});
}

async function loadPredefMasks(){
  const res=await fetch('/predefined_masks');
  const data=await res.json();
  document.getElementById('predef-masks').value=data.join(', ');
}

async function loadHashesJobs(){
  const res=await fetch('/hashes_jobs');
  const jobs=await res.json();
  const tbody=document.getElementById('hashes-job-body');
  tbody.innerHTML='';
  for(const j of jobs){
    const tr=document.createElement('tr');
    const idTd=document.createElement('td');
    idTd.textContent=j.id;
    const algoTd=document.createElement('td');
    algoTd.textContent=j.algorithmName||'';
    const prioTd=document.createElement('td');
    const inp=document.createElement('input');
    inp.type='number';
    inp.value=j.priority||0;
    prioTd.appendChild(inp);
    const actionTd=document.createElement('td');
    const btn=document.createElement('button');
    btn.textContent='Set';
    btn.onclick=async()=>{
      await fetch('/hashes_job_config',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({job_id:j.id,priority:parseInt(inp.value,10)||0})});
    };
    actionTd.appendChild(btn);
    tr.appendChild(idTd);tr.appendChild(algoTd);tr.appendChild(prioTd);tr.appendChild(actionTd);
    tbody.appendChild(tr);
  }
}

async function loadAlgoParams(){
  const res=await fetch('/hashes_settings');
  const data=await res.json();
  if(data.hashes_poll_interval!==undefined){
    document.getElementById('hashes-poll').value=data.hashes_poll_interval;
  }
  document.getElementById('algo-params-output').textContent=JSON.stringify(data.algo_params||{},null,2);
}

async function saveAlgoParams(){
  const algo=document.getElementById('algo-name').value.trim();
  if(!algo) return;
  const mask_length=parseInt(document.getElementById('algo-masklen').value,10);
  const rule=document.getElementById('algo-rule').value.trim();
  const params={};
  if(mask_length) params.mask_length=mask_length;
  if(rule) params.rule=rule;
  const body={algo_params:{}};
  body.algo_params[algo.toLowerCase()]=params;
  await fetch('/hashes_settings',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  loadAlgoParams();
}

async function trainMarkov(){
  const lang=document.getElementById('markov-language').value;
  await fetch('/train_markov',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({lang})});
}

async function updateProbOrder(){
  const enabled=document.getElementById('prob-order').checked;
  await fetch('/probabilistic_order',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({enabled})});
  updateMetrics();
}

async function updateInverseOrder(){
  const enabled=document.getElementById('inverse-order').checked;
  await fetch('/inverse_prob_order',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({enabled})});
  updateMetrics();
}

async function changeMarkovLang(){
  const lang=document.getElementById('markov-language').value;
  await fetch('/markov_lang',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({lang})});
  updateMetrics();
}

async function trainLLM(){
  const dataset=document.getElementById('llm-dataset').value.trim();
  const model=document.getElementById('llm-base-model').value.trim();
  const epochs=parseInt(document.getElementById('llm-epochs').value,10)||0;
  const learning_rate=parseFloat(document.getElementById('llm-lr').value)||0;
  const output_dir=document.getElementById('llm-output').value.trim();
  await fetch('/train_llm',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({dataset_path:dataset,base_model_path:model,epochs,learning_rate,output_dir})
  });
}

function tick(){
  updateMetrics();
  loadDicts();
  loadMasks();
  loadRestores();
  loadWorkers();
  loadJobs();
  loadLogs();
  loadHashesJobs();
  loadPredefMasks();
  loadAlgoParams();
}

function startWS(){
  const proto = location.protocol === 'https:' ? 'wss' : 'ws';
  const ws = new WebSocket(`${proto}://${location.host}/ws/portal`);
  ws.onmessage = ev => {
    const msg = JSON.parse(ev.data);
    if(msg.metrics) applyMetrics(msg.metrics);
    if(msg.founds && msg.founds.length){
      const pre=document.getElementById('found-output');
      pre.textContent += msg.founds.join('\n')+'\n';
    }
    if(msg.workers) loadWorkers();
  };
  ws.onclose = () => setTimeout(startWS, 1000);
}

function showLogin(){
  document.getElementById('login-overlay').style.display='flex';
}

async function submitPasskey(){
  const key=document.getElementById('passkey').value.trim();
  if(!key) return;
  const res=await fetch('/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({passkey:key})});
  if(res.ok){
    const data=await res.json();
    document.cookie=`session=${data.cookie}; path=/`;
    location.reload();
  }else{
    document.getElementById('login-error').textContent='Invalid passkey';
  }
}

function logout(){
  const m=document.cookie.match(/(?:^|; )session=([^;]+)/);
  if(m){
    fetch('/logout',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token:m[1]})});
  }
  document.cookie='session=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';
  location.reload();
}

const origFetch=window.fetch;
window.fetch=async(...args)=>{
  const res=await origFetch(...args);
  if(res.status===401){
    showLogin();
    throw new Error('Unauthorized');
  }
  return res;
};

async function init(){
  const res=await fetch('/server_status');
  if(res.status===401){ showLogin(); return; }
  const data=await res.json();
  applyMetrics(data);
  setInterval(tick,30000);
  tick();
  startWS();
}

init();
</script>
</body>
</html>

