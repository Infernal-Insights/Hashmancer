<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Portal Login</title>
<link href="https://fonts.googleapis.com/css2?family=UnifrakturCook&display=swap" rel="stylesheet">
<style>
:root {
    --primary-color: #0f0;
    --background-color: #000;
    --secondary-color: #111;
    --error-color: #f00;
    --border-color: #0f0;
    --text-color: #0f0;
    --border-radius: 8px;
    --box-shadow: 0 2px 8px rgba(0, 255, 0, 0.1);
    --transition: all 0.3s ease;
}

* {
    box-sizing: border-box;
}

body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 20px;
    background: var(--background-color);
    color: var(--text-color);
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
}

.login-container {
    background: var(--secondary-color);
    border: 2px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: 30px;
    width: 100%;
    max-width: 400px;
    box-shadow: var(--box-shadow);
    text-align: center;
}

h1 {
    color: var(--primary-color);
    font-family: 'UnifrakturCook', cursive;
    margin-bottom: 30px;
    text-shadow: 0 0 10px var(--primary-color);
    font-size: 2.5em;
}

.form-group {
    margin-bottom: 20px;
    text-align: left;
}

label {
    display: block;
    margin-bottom: 5px;
    font-size: 14px;
    color: var(--text-color);
}

input[type="password"] {
    width: 100%;
    padding: 12px;
    background: var(--background-color);
    color: var(--text-color);
    border: 2px solid var(--border-color);
    border-radius: var(--border-radius);
    font-size: 16px;
    transition: var(--transition);
}

input[type="password"]:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
}

.btn {
    width: 100%;
    padding: 12px;
    margin: 8px 0;
    background: var(--secondary-color);
    color: var(--text-color);
    border: 2px solid var(--border-color);
    border-radius: var(--border-radius);
    cursor: pointer;
    font-size: 16px;
    transition: var(--transition);
}

.btn:hover:not(:disabled) {
    background: var(--primary-color);
    color: var(--background-color);
    box-shadow: 0 0 15px var(--primary-color);
}

.btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.btn.danger {
    border-color: var(--error-color);
}

.btn.danger:hover:not(:disabled) {
    background: var(--error-color);
    box-shadow: 0 0 15px var(--error-color);
}

.error-message {
    background: rgba(255, 0, 0, 0.1);
    color: var(--error-color);
    border: 1px solid var(--error-color);
    border-radius: var(--border-radius);
    padding: 12px;
    margin: 15px 0;
    display: none;
    font-size: 14px;
}

.loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 2px solid transparent;
    border-top: 2px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-left: 10px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Mobile Responsive */
@media (max-width: 480px) {
    body {
        padding: 10px;
    }
    
    .login-container {
        padding: 20px;
    }
    
    h1 {
        font-size: 2em;
    }
}

/* Accessibility */
@media (prefers-reduced-motion: reduce) {
    * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
}
</style>
</head>
<body>
<div class="login-container">
  <h1>Portal Login</h1>
  
  <form id="login-form" onsubmit="submitPasskey(event)">
    <div class="form-group">
      <label for="passkey">Passkey</label>
      <input type="password" id="passkey" placeholder="Enter your passkey" required>
    </div>
    
    <button type="submit" class="btn" id="login-btn">
      <span id="login-text">Login</span>
      <span class="loading" id="login-loading" style="display: none;"></span>
    </button>
  </form>
  
  <button class="btn danger" onclick="logout()">Logout</button>
  
  <div class="error-message" id="login-error"></div>
</div>
<script>
class LoginManager {
    constructor() {
        this.isLoading = false;
        this.setupEventListeners();
    }

    setupEventListeners() {
        // Enter key support
        document.getElementById('passkey').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !this.isLoading) {
                this.submitPasskey(e);
            }
        });
    }

    showError(message) {
        const errorDiv = document.getElementById('login-error');
        if (errorDiv) {
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
    }

    showLoading(isLoading) {
        this.isLoading = isLoading;
        const loginText = document.getElementById('login-text');
        const loginLoading = document.getElementById('login-loading');
        const loginBtn = document.getElementById('login-btn');
        
        if (loginText && loginLoading && loginBtn) {
            if (isLoading) {
                loginText.style.display = 'none';
                loginLoading.style.display = 'inline-block';
                loginBtn.disabled = true;
            } else {
                loginText.style.display = 'inline';
                loginLoading.style.display = 'none';
                loginBtn.disabled = false;
            }
        }
    }

    async submitPasskey(event) {
        if (event) {
            event.preventDefault();
        }
        
        if (this.isLoading) return;

        const key = document.getElementById('passkey').value.trim();
        if (!key) {
            this.showError('Please enter your passkey');
            return;
        }

        this.showLoading(true);
        
        try {
            const response = await fetch('/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ passkey: key })
            });

            if (response.ok) {
                const data = await response.json();
                document.cookie = `session=${data.cookie}; path=/`;
                
                // Clear form
                document.getElementById('passkey').value = '';
                
                // Redirect with smooth transition
                window.location.href = '/portal';
            } else {
                let errorMessage = 'Invalid passkey';
                
                if (response.status === 429) {
                    errorMessage = 'Too many attempts. Please try again later.';
                } else if (response.status >= 500) {
                    errorMessage = 'Server error. Please try again.';
                }
                
                this.showError(errorMessage);
                
                // Clear password field on error
                document.getElementById('passkey').value = '';
                document.getElementById('passkey').focus();
            }
        } catch (error) {
            console.error('Login error:', error);
            this.showError('Connection error. Please check your network and try again.');
        } finally {
            this.showLoading(false);
        }
    }

    logout() {
        const sessionMatch = document.cookie.match(/(?:^|; )session=([^;]+)/);
        if (sessionMatch) {
            fetch('/logout', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: sessionMatch[1] })
            }).catch(console.error);
        }
        
        document.cookie = 'session=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';
        location.reload();
    }
}

// Global functions for backward compatibility
async function submitPasskey(event) {
    if (window.loginManager) {
        await window.loginManager.submitPasskey(event);
    }
}

function logout() {
    if (window.loginManager) {
        window.loginManager.logout();
    }
}

// Initialize login manager when page loads
document.addEventListener('DOMContentLoaded', () => {
    window.loginManager = new LoginManager();
    
    // Focus on passkey input
    const passkeyInput = document.getElementById('passkey');
    if (passkeyInput) {
        passkeyInput.focus();
    }
});
</script>
</body>
</html>
